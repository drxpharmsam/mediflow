<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>MediFlow Web App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --c1: #A5E6E2; --c2: #77DAD7; --c3: #36B8B7;
            --c4: #0A858C; --c5: #0B757B; --error: #E63946; --success: #2D6A4F; --white: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Plus Jakarta Sans', sans-serif; background-color: #E0F7F6; overflow: hidden; display: flex; justify-content: center; align-items: center; }

        #app-frame {
            width: 100%; height: 100%; 
            background: #F8FEFD; 
            position: relative; 
            overflow: hidden; 
            display: flex; flex-direction: column;
        }

        @media (min-width: 768px) {
            #app-frame { width: 400px; height: 850px; border-radius: 40px; box-shadow: 0 40px 80px rgba(11, 117, 123, 0.25); border: 8px solid #333; }
        }

        /* LOADERS */
        #pill-loader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--c5); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; transition: opacity 0.5s; }
        .pill-icon { font-size: 50px; color: var(--c1); animation: bouncePill 1.2s ease-in-out infinite; }
        @keyframes bouncePill { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-25px) rotate(180deg); } }

        /* SCREENS */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; z-index: 10; background: #F8FEFD; }
        .hidden { opacity: 0; pointer-events: none; transform: translateX(50px); }

        .auth-bg { background: linear-gradient(180deg, var(--c1) 0%, var(--c3) 100%); padding: 60px 30px; z-index: 200; }
        .glass-sheet { position: absolute; bottom: 0; left: 0; right: 0; top: 22%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(25px); border-top-left-radius: 40px; border-top-right-radius: 40px; padding: 40px 30px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); overflow-y: auto; }

        /* INPUTS */
        .shake-input { animation: shake 0.3s ease-in-out; border-color: var(--error) !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 11px; font-weight: 800; color: var(--c4); margin-bottom: 8px; text-transform: uppercase; }
        .input-group input { width: 100%; height: 55px; background: white; border: 2px solid #eee; border-radius: 15px; padding: 0 20px; font-size: 18px; outline: none; transition: 0.3s; }
        .error-hint { color: var(--error); font-size: 11px; font-weight: 700; margin-top: 5px; display: none; }
        .gender-selection { display: flex; gap: 10px; margin-bottom: 10px; }
        .gender-chip { flex: 1; padding: 15px; border-radius: 15px; background: #fff; border: 2px solid #f0f0f0; text-align: center; font-size: 13px; font-weight: 700; color: #888; cursor: pointer; transition: 0.2s; }
        .gender-chip.selected { background: var(--c1); border-color: var(--c3); color: var(--c5); transform: scale(1.05); }

        /* DASHBOARD HEADER */
        .header-aura { position: absolute; top: 0; left: 0; right: 0; height: 190px; background: linear-gradient(135deg, var(--c5), var(--c3)); border-bottom-left-radius: 40px; border-bottom-right-radius: 40px; padding: 50px 25px 0; color: white; z-index: 50; }
        .search-container { margin-top: 25px; position: relative; z-index: 100; }
        .search-input { width: 100%; height: 55px; background: var(--white); border: none; border-radius: 20px; padding: 0 20px 0 55px; font-size: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); outline: none; }
        .search-icon { position: absolute; left: 22px; top: 18px; color: var(--c4); }

        /* SCROLL AREA */
        #main-scroll { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding-top: 210px; padding-bottom: 100px; }
        .content-view { padding: 0 20px; display: none; }
        .content-view.active-view { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* FIXED NAV DOCK (Solid Bottom) */
        .nav-dock { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 80px; 
            background: white; 
            border-radius: 25px 25px 0 0; 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            box-shadow: 0 -5px 25px rgba(0,0,0,0.1); 
            z-index: 100; 
        }
        .nav-item { color: rgba(255,255,255,0.4); font-size: 22px; cursor: pointer; transition: 0.3s; position: relative; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .nav-item.active { background: var(--c1); color: var(--c5); transform: translateY(-5px); }

        /* CARDS */
        .service-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .glass-card { background: white; border-radius: 28px; padding: 22px; box-shadow: 0 8px 20px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: space-between; min-height: 170px; cursor: pointer; }
        .wide { grid-column: span 2; min-height: 100px; flex-direction: row; align-items: center; margin-bottom: 10px; }
        .icon-orb { width: 50px; height: 50px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; margin-bottom: 12px; }
        .orb-1 { background: #E0F7F6; color: var(--c5); }
        .orb-2 { background: #FFE8D6; color: #D08A56; }
        .orb-3 { background: #D6E4FF; color: #5684D0; }
        .wide .icon-orb { margin-bottom: 0; margin-right: 15px; }

        /* CONSULTATION UI */
        .section-label { font-size: 11px; font-weight: 800; color: var(--c4); display: block; margin: 20px 0 10px; text-transform: uppercase; letter-spacing: 1px; }
        .select-chip { padding: 15px; background: white; border: 2px solid #eee; border-radius: 15px; text-align: center; font-size: 13px; font-weight: 700; cursor: pointer; transition: 0.3s; color: #888; }
        .select-chip.active { border-color: var(--c3); background: var(--c1); color: var(--c5); }
        .mode-card { flex: 1; padding: 20px; background: white; border: 2px solid #eee; border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
        .mode-card.active { border-color: var(--c3); background: var(--c1); color: var(--c5); }
        .pay-btn { width: 100%; height: 60px; background: var(--c5); color: white; border: none; border-radius: 20px; font-size: 18px; font-weight: 800; box-shadow: 0 10px 20px rgba(11,117,123,0.3); margin-top: 20px; }
        
        #payment-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

<div id="app-frame">

    <div id="pill-loader">
        <i class="fa-solid fa-pills pill-icon"></i>
        <p style="margin-top: 15px; letter-spacing: 2px; font-size: 12px; font-weight: 700;" id="loader-text">LOADING</p>
    </div>

    <div id="screen-login" class="screen auth-bg">
        <h1 style="color: var(--c5); font-size: 38px; margin: 0; letter-spacing: -1.5px;">MediFlow</h1>
        <div class="glass-sheet">
            <h2>Welcome</h2>
            <p style="color: #666; font-size: 14px;">Auto-verifies after 10 digits.</p>
            <div class="input-group">
                <label>Mobile Number</label>
                <input type="tel" id="login-phone" placeholder="0000-000-000" maxlength="12" oninput="autoPhone(this)">
                <div id="phone-err" class="error-hint">Incorrect mobile format</div>
            </div>
        </div>
    </div>

    <div id="screen-otp" class="screen auth-bg hidden">
        <h1 style="color: var(--c5); font-size: 38px; margin: 0;">Verify</h1>
        <div class="glass-sheet">
            <h2>Enter Code</h2>
            <div style="display:flex; justify-content:space-between; margin: 25px 0;">
                <input type="tel" class="otp-box" id="otp-1" maxlength="1" oninput="m(this)" style="width:45px; height:55px; border:2px solid var(--c2); border-radius:12px; text-align:center; font-size:20px; font-weight:800;" inputmode="numeric">
                <input type="tel" class="otp-box" maxlength="1" oninput="m(this)" style="width:45px; height:55px; border:2px solid var(--c2); border-radius:12px; text-align:center; font-size:20px; font-weight:800;" inputmode="numeric">
                <input type="tel" class="otp-box" maxlength="1" oninput="m(this)" style="width:45px; height:55px; border:2px solid var(--c2); border-radius:12px; text-align:center; font-size:20px; font-weight:800;" inputmode="numeric">
                <input type="tel" class="otp-box" maxlength="1" oninput="m(this)" style="width:45px; height:55px; border:2px solid var(--c2); border-radius:12px; text-align:center; font-size:20px; font-weight:800;" inputmode="numeric">
                <input type="tel" class="otp-box" maxlength="1" oninput="m(this)" style="width:45px; height:55px; border:2px solid var(--c2); border-radius:12px; text-align:center; font-size:20px; font-weight:800;" inputmode="numeric">
                <input type="tel" class="otp-box" maxlength="1" oninput="m(this)" style="width:45px; height:55px; border:2px solid var(--c2); border-radius:12px; text-align:center; font-size:20px; font-weight:800;" inputmode="numeric">
            </div>
            <div id="otp-err" class="error-hint" style="text-align:center">Incorrect 6-digit code</div>
        </div>
    </div>

    <div id="screen-profile" class="screen auth-bg hidden">
        <h1 style="color: var(--c5); font-size: 38px; margin: 0;">Identity</h1>
        <div class="glass-sheet" style="top: 15%;">
            <h2>Personal Info</h2>
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="user-name" placeholder="Name" oninput="clearErr('name-err')">
                <div id="name-err" class="error-hint">Minimum 3 characters required</div>
            </div>
            <div class="input-group">
                <label>Age</label>
                <input type="number" id="user-age" placeholder="25" oninput="clearErr('age-err')">
                <div id="age-err" class="error-hint">Please enter a valid age</div>
            </div>
            <label style="font-size:11px; font-weight:800; color:var(--c4);">GENDER</label>
            <div class="gender-selection">
                <div class="gender-chip" onclick="selG(this, 'Male')">Male</div>
                <div class="gender-chip" onclick="selG(this, 'Female')">Female</div>
            </div>
            <button onclick="saveProfileToCloud()" style="width:100%; height:55px; background:var(--c5); color:white; border:none; border-radius:15px; font-size:16px; font-weight:700; margin-top:10px; box-shadow:0 10px 20px rgba(11,117,123,0.2);">COMPLETE SIGNUP</button>
        </div>
    </div>

    <div id="screen-dash" class="screen dashboard-bg hidden">
        <div class="header-aura">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <p style="margin:0; opacity:0.8; font-size:14px;">Welcome back,</p>
                    <h2 id="dash-user" style="margin:0; font-size:26px;">User</h2>
                </div>
                <div id="initial-box" style="width:45px; height:45px; background:var(--white); border-radius:12px; display:flex; align-items:center; justify-content:center; color:var(--c5); font-weight:800;">U</div>
            </div>
            <div class="search-container">
                <i class="fa-solid fa-magnifying-glass search-icon"></i>
                <input type="text" class="search-input" placeholder="Search medicines or doctors..." onkeyup="liveSearch(this)">
            </div>
        </div>

        <div id="main-scroll">
            
            <div id="tab-home" class="content-view active-view">
                <div style="margin-bottom:15px;"><h3 style="margin:0;">Our Services</h3></div>
                <div class="service-grid">
                    <div class="glass-card wide searchable" data-name="prescription upload scan">
                        <div class="icon-orb orb-1"><i class="fa-solid fa-camera-retro"></i></div>
                        <div style="margin-left:15px;"><h3 style="margin:0; font-size:16px;">Upload Prescription</h3><p style="margin:2px 0 0; font-size:12px; opacity:0.6;">Scan with AI</p></div>
                    </div>
                    <div class="glass-card searchable" data-name="doctor consult video" onclick="triggerDoctorTab()">
                        <div class="icon-orb orb-2"><i class="fa-solid fa-user-doctor"></i></div>
                        <div><h3 style="margin:0; font-size:15px;">Doctor<br>Consult</h3></div>
                    </div>
                    <div class="glass-card searchable" data-name="pharmacy pills shop">
                        <div class="icon-orb orb-3"><i class="fa-solid fa-capsules"></i></div>
                        <div><h3 style="margin:0; font-size:15px;">Pharmacy<br>Store</h3></div>
                    </div>
                </div>
            </div>

            <div id="tab-category" class="content-view">
                <div style="margin-bottom:15px;"><h3 style="margin:0;">Categories</h3></div>
                <div class="service-grid">
                    <div class="glass-card" style="min-height:120px;"><i class="fa-solid fa-heart-pulse" style="font-size:24px; color:var(--c5); margin-bottom:10px;"></i><h3 style="margin:0; font-size:14px;">Cardiac<br>Care</h3></div>
                    <div class="glass-card" style="min-height:120px;"><i class="fa-solid fa-baby" style="font-size:24px; color:#D08A56; margin-bottom:10px;"></i><h3 style="margin:0; font-size:14px;">Baby<br>Care</h3></div>
                    <div class="glass-card" style="min-height:120px;"><i class="fa-solid fa-brain" style="font-size:24px; color:#5684D0; margin-bottom:10px;"></i><h3 style="margin:0; font-size:14px;">Neuro<br>Health</h3></div>
                    <div class="glass-card" style="min-height:120px;"><i class="fa-solid fa-bone" style="font-size:24px; color:#77DAD7; margin-bottom:10px;"></i><h3 style="margin:0; font-size:14px;">Ortho<br>Care</h3></div>
                </div>
            </div>

            <div id="tab-doctor" class="content-view">
                <div style="margin-bottom:15px;"><h3 style="margin:0;">Find Specialist</h3></div>
                <div class="service-grid" style="margin-bottom:25px;">
                    <div class="glass-card" onclick="checkAvailability()">
                        <i class="fa-solid fa-stethoscope" style="font-size:30px; color:var(--c5); margin-bottom:10px;"></i>
                        <h3 style="margin:0; font-size:14px;">General</h3>
                    </div>
                    <div class="glass-card" onclick="checkAvailability()">
                        <i class="fa-solid fa-heart-pulse" style="font-size:30px; color:#E63946; margin-bottom:10px;"></i>
                        <h3 style="margin:0; font-size:14px;">Heart</h3>
                    </div>
                    <div class="glass-card" onclick="checkAvailability()">
                        <i class="fa-solid fa-tooth" style="font-size:30px; color:#457B9D; margin-bottom:10px;"></i>
                        <h3 style="margin:0; font-size:14px;">Dentist</h3>
                    </div>
                    <div class="glass-card" onclick="checkAvailability()">
                        <i class="fa-solid fa-brain" style="font-size:30px; color:#9B5DE5; margin-bottom:10px;"></i>
                        <h3 style="margin:0; font-size:14px;">Brain</h3>
                    </div>
                </div>

                <div style="margin-bottom:15px;"><h3 style="margin:0;">Top Doctors</h3></div>
                <div class="glass-card wide">
                    <div class="icon-orb orb-2"><i class="fa-solid fa-user-md"></i></div>
                    <div style="margin-left:15px; flex:1;">
                        <h3 style="margin:0; font-size:16px;">Dr. Strange</h3>
                        <p style="margin:2px 0 0; font-size:12px; opacity:0.6;">Surgeon • 5.0★</p>
                    </div>
                    <div onclick="openConsultation()" style="background:var(--c5); color:white; padding:8px 15px; border-radius:10px; font-size:12px; font-weight:bold; cursor:pointer;">Book</div>
                </div>
                <div class="glass-card wide">
                    <div class="icon-orb orb-3"><i class="fa-solid fa-user-nurse"></i></div>
                    <div style="margin-left:15px; flex:1;">
                        <h3 style="margin:0; font-size:16px;">Dr. House</h3>
                        <p style="margin:2px 0 0; font-size:12px; opacity:0.6;">General • 4.8★</p>
                    </div>
                    <div onclick="openConsultation()" style="background:var(--c5); color:white; padding:8px 15px; border-radius:10px; font-size:12px; font-weight:bold; cursor:pointer;">Book</div>
                </div>
            </div>

            <div id="tab-delivery" class="content-view">
                <div style="margin-bottom:15px;"><h3 style="margin:0;">Delivery Status</h3></div>
                <div class="glass-card wide">
                    <div class="icon-orb orb-3"><i class="fa-solid fa-truck-fast"></i></div>
                    <div style="margin-left:15px;"><h3 style="margin:0; font-size:16px;">No Active Orders</h3><p style="margin:2px 0 0; font-size:12px; opacity:0.6;">Order medicines to track</p></div>
                </div>
            </div>

            <div id="tab-profile" class="content-view">
                <div style="margin-bottom:15px;"><h3 style="margin:0;">My Account</h3></div>
                <div class="glass-card wide">
                     <div class="icon-orb orb-1"><i class="fa-solid fa-user-shield"></i></div>
                     <div style="margin-left:15px;"><h3 id="db-name-disp" style="margin:0; font-size:16px;">User</h3><p id="db-info-disp" style="margin:2px 0 0; font-size:12px; opacity:0.6;">Details</p></div>
                </div>
                <div class="glass-card wide" onclick="dbLogout()" style="cursor:pointer; border:1px solid rgba(230,57,70,0.3);">
                    <div class="icon-orb" style="background:#FFE5E5; color:var(--error);"><i class="fa-solid fa-power-off"></i></div>
                    <div style="margin-left:15px;"><h3 style="color:var(--error); margin:0; font-size:16px;">Logout</h3><p style="margin:2px 0 0; font-size:12px; opacity:0.6;">Securely end session</p></div>
                </div>
            </div>
        </div>

        <div class="nav-dock">
            <i class="fa-solid fa-house nav-item active" onclick="switchTab(this, 'tab-home')"></i>
            <i class="fa-solid fa-layer-group nav-item" onclick="switchTab(this, 'tab-category')"></i>
            <i id="nav-btn-doc" class="fa-solid fa-user-doctor nav-item" onclick="switchTab(this, 'tab-doctor')"></i>
            <i class="fa-solid fa-truck-fast nav-item" onclick="switchTab(this, 'tab-delivery')"></i>
            <i class="fa-solid fa-user nav-item" onclick="switchTab(this, 'tab-profile')"></i>
        </div>
    </div>

    <div id="screen-consult" class="screen hidden">
        <div class="header-aura" style="height:120px; padding-top:20px;">
            <i class="fa-solid fa-arrow-left" onclick="closeConsultation()" style="cursor:pointer; font-size:24px; color:white;"></i>
            <h2 style="margin:10px 0 0; color:white;">Book Slot</h2>
        </div>
        <div style="margin-top:130px; padding:20px; flex:1; overflow-y:auto;">
            <label class="section-label">Select Time</label>
            <div class="service-grid">
                <div class="select-chip active" onclick="selUI(this)">10:30 AM</div>
                <div class="select-chip" onclick="selUI(this)">12:00 PM</div>
                <div class="select-chip" onclick="selUI(this)">04:15 PM</div>
                <div class="select-chip" onclick="selUI(this)">08:30 PM</div>
            </div>
            
            <label class="section-label">Mode</label>
            <div style="display:flex; gap:10px;">
                <div class="mode-card active" onclick="selMode(this)"><i class="fa-solid fa-video"></i><p>Video</p></div>
                <div class="mode-card" onclick="selMode(this)"><i class="fa-solid fa-message"></i><p>Chat</p></div>
            </div>
            
            <button class="pay-btn" onclick="openPayment()">PROCEED TO PAY</button>
        </div>
    </div>

    <div id="payment-overlay" class="hidden" style="position:absolute; inset:0; background:rgba(0,0,0,0.8); z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px;">
        <div style="background:white; padding:30px; border-radius:30px; width:100%; text-align:center;">
            <i class="fa-solid fa-shield-halved" style="font-size:40px; color:var(--success);"></i>
            <h2>₹59.00</h2>
            <div style="height:100px; background:#f0f0f0; border:1px dashed #ccc; border-radius:20px; margin:20px 0; display:flex; align-items:center; justify-content:center; color:#999;">UPI / CARD SIMULATOR</div>
            <button onclick="verifyPayment()" style="width:100%; height:55px; background:var(--success); color:white; border:none; border-radius:15px; font-weight:800;">CONFIRM PAY</button>
            <p onclick="closePayment()" style="margin-top:15px; color:var(--error); cursor:pointer;">Cancel</p>
        </div>
    </div>

</div>

<script>
    const API_URL = "https://sheetdb.io/api/v1/p5nysi4nje2ch"; 
    
    let currentPhoneRaw = "";
    let currentPhoneClean = "";
    let gender = "";

    window.onload = () => {
        const savedUser = JSON.parse(localStorage.getItem('mediflow_user'));
        if(savedUser) {
            loading(true, "WELCOME BACK");
            updateDash(savedUser);
            setTimeout(() => {
                loading(false);
                showScreen('screen-dash');
            }, 1500);
        } else {
            loading(false);
        }
        setTimeout(() => loading(false), 5000);
    };

    function autoPhone(el) {
        clearErr('phone-err');
        let v = el.value.replace(/\D/g, '');
        if (v.length > 4 && v.length <= 7) v = v.slice(0,4) + '-' + v.slice(4);
        if (v.length > 7) v = v.slice(0,4) + '-' + v.slice(4,7) + '-' + v.slice(7);
        el.value = v;

        if(v.length === 12) {
            currentPhoneRaw = v;
            currentPhoneClean = v.replace(/-/g, '');
            el.classList.add('valid-input');
            setTimeout(() => {
                showScreen('screen-otp');
                setTimeout(() => document.getElementById('otp-1').focus(), 600);
            }, 400);
        } else if (v.length > 12) { applyShake(el, 'phone-err'); }
    }

    function m(el) {
        clearErr('otp-err');
        if(el.value && el.nextElementSibling) el.nextElementSibling.focus();
        let code = "";
        document.querySelectorAll('.otp-box').forEach(b => code += b.value);
        if(code.length === 6) {
            if(code === "123456") {
                checkCloudLogin();
            } else {
                document.querySelectorAll('.otp-box').forEach(b => { applyShake(b, 'otp-err'); b.value = ""; });
                document.getElementById('otp-1').focus();
            }
        }
    }

    async function checkCloudLogin() {
        loading(true, "CHECKING DATABASE...");
        try {
            const res = await fetch(`${API_URL}/search?phone=${currentPhoneClean}`);
            const data = await res.json();
            if(data.length > 0) {
                const user = data[0];
                localStorage.setItem('mediflow_user', JSON.stringify(user));
                updateDash(user);
                loading(false);
                showScreen('screen-dash');
            } else {
                loading(false);
                showScreen('screen-profile');
            }
        } catch(e) {
            alert("Connection Error");
            loading(false);
            showScreen('screen-login');
        }
    }

    function selG(el, g) {
        document.querySelectorAll('.gender-chip').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        gender = g;
    }

    async function saveProfileToCloud() {
        const n = document.getElementById('user-name').value;
        const a = document.getElementById('user-age').value;
        if(n.length < 3) { applyShake(document.getElementById('user-name'), 'name-err'); return; }
        if(a < 1) { applyShake(document.getElementById('user-age'), 'age-err'); return; }
        if(gender === "") { alert("Select Gender"); return; }

        loading(true, "CREATING ACCOUNT...");
        const newUser = { phone: currentPhoneClean, name: n, age: a, gender: gender };

        try {
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: newUser })
            });
            localStorage.setItem('mediflow_user', JSON.stringify(newUser));
            updateDash(newUser);
            setTimeout(() => {
                loading(false);
                showScreen('screen-dash');
            }, 1000);
        } catch(e) {
            alert("Save Failed.");
            loading(false);
        }
    }

    function triggerDoctorTab() {
        document.getElementById('nav-btn-doc').click();
    }

    function checkAvailability() {
        loading(true, "CHECKING AVAILABILITY...");
        setTimeout(() => {
            loading(false);
            openConsultation();
        }, 2000);
    }

    function openConsultation() { 
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('screen-consult').classList.remove('hidden'); 
    }
    
    function closeConsultation() { 
        document.getElementById('screen-consult').classList.add('hidden');
        document.getElementById('screen-dash').classList.remove('hidden');
    }
    
    function selUI(el) { el.parentNode.querySelectorAll('.select-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
    function selMode(el) { document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('active')); el.classList.add('active'); }
    
    function openPayment() { document.getElementById('payment-overlay').classList.remove('hidden'); }
    function closePayment() { document.getElementById('payment-overlay').classList.add('hidden'); }

    function verifyPayment() {
        loading(true, "VERIFYING...");
        setTimeout(() => {
            closePayment();
            loading(true, "CONNECTING...");
            setTimeout(() => {
                loading(false);
                alert("Success! Redirecting to Video...");
                window.location.href = "https://meet.google.com/new";
            }, 1500);
        }, 1500);
    }

    function updateDash(user) {
        document.getElementById('dash-user').innerText = user.name;
        document.getElementById('initial-box').innerText = user.name.charAt(0).toUpperCase();
        document.getElementById('db-name-disp').innerText = user.name;
        document.getElementById('db-info-disp').innerText = `${user.age} Years • ${user.gender}`;
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function switchTab(el, tabId) {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.content-view').forEach(v => v.classList.remove('active-view'));
        document.getElementById(tabId).classList.add('active-view');
    }

    function liveSearch(el) {
        let q = el.value.toLowerCase();
        document.querySelectorAll('.searchable').forEach(c => {
            c.style.display = c.getAttribute('data-name').includes(q) ? 'flex' : 'none';
        });
    }

    function loading(show, text) {
        const l = document.getElementById('pill-loader');
        if(show) {
            if(text) document.getElementById('loader-text').innerText = text;
            l.style.display = 'flex';
        } else {
            l.style.display = 'none';
        }
    }

    function applyShake(el, errId) {
        el.classList.add('shake-input');
        document.getElementById(errId).style.display = 'block';
        setTimeout(() => el.classList.remove('shake-input'), 300);
    }

    function clearErr(errId) { document.getElementById(errId).style.display = 'none'; }

    function dbLogout() {
        if(confirm("Logout and clear data?")) {
            localStorage.removeItem('mediflow_user');
            location.reload();
        }
    }
</script>
</body>
</html>